# Story 1.1: Knowledge Management Database Schema Foundation

## Status
Draft

## Story
**As a** Backend Developer,
**I want** to design and implement the Prisma database schema for Knowledge Management core entities,
**so that** the application can store and manage documents, communications, facts, tags, categories, and knowledge sources with proper relationships and data integrity.

## Acceptance Criteria
1. Create `Document` model to store uploaded documents with metadata, versioning, and MinIO file references
2. Create `Communication` model to store communication records (emails, chat logs, etc.) with content and metadata
3. Create `Fact` model to store extracted facts with content, confidence scores, and approval status
4. Create `Tag` model to store classification tags with hierarchical relationships
5. Create `Category` model to store knowledge categorization with parent-child relationships
6. Create `KnowledgeSource` model to store external knowledge source configurations
7. All models must include proper foreign key relationships and referential integrity
8. All models must include standard audit fields (createdAt, updatedAt, createdBy, etc.)
9. Database migration scripts must be created and tested
10. Models must include appropriate indexes for performance optimization

## Tasks / Subtasks

- [ ] Task 1: Design Document model schema (AC: 1)
  - [ ] Define Document table with id, name, description, type, mimeType, filePath, fileSize, checksum, version, status fields
  - [ ] Add relationships to transition, user (submitter), and approval workflow
  - [ ] Include MinIO storage path reference and file metadata
  - [ ] Add security classification and expiration fields
  - [ ] Include audit trail fields (createdAt, updatedAt, createdBy, etc.)

- [ ] Task 2: Design Communication model schema (AC: 2)
  - [ ] Define Communication table with id, type, direction, platform, content, subject fields
  - [ ] Add sender/receiver relationships and external platform integration fields
  - [ ] Include thread management and reply-to relationships
  - [ ] Add metadata for different communication platforms (Teams, Slack, Email)
  - [ ] Include audit trail and processing status fields

- [ ] Task 3: Design Fact model schema (AC: 3)
  - [ ] Define Fact table with id, content, sourceDocument, extractionMethod, confidence fields
  - [ ] Add approval workflow fields (status, approvedBy, rejectedReason)
  - [ ] Include fact categorization and tagging relationships
  - [ ] Add semantic metadata and vector embedding references
  - [ ] Include audit trail and version control fields

- [ ] Task 4: Design Tag model schema (AC: 4)
  - [ ] Define Tag table with id, name, description, color, hierarchical parent relationship
  - [ ] Add usage statistics and visibility controls
  - [ ] Include tag type classification (manual, auto-generated, system)
  - [ ] Add many-to-many relationships with facts, documents, and communications
  - [ ] Include audit trail fields

- [ ] Task 5: Design Category model schema (AC: 5)
  - [ ] Define Category table with id, name, description, parent-child relationships
  - [ ] Add category path and depth for hierarchical queries
  - [ ] Include visibility and access control fields
  - [ ] Add many-to-many relationships with knowledge entities
  - [ ] Include audit trail fields

- [ ] Task 6: Design KnowledgeSource model schema (AC: 6)
  - [ ] Define KnowledgeSource table with id, name, type, connectionConfig, isActive fields
  - [ ] Add external system integration configuration (ServiceNow, ADO, etc.)
  - [ ] Include sync status, last sync timestamp, and error handling fields
  - [ ] Add access credentials and authentication configuration
  - [ ] Include audit trail and monitoring fields

- [ ] Task 7: Create Prisma schema file with all models (AC: 7, 8)
  - [ ] Define all models in schema.prisma with proper relationships
  - [ ] Add foreign key constraints and referential integrity rules
  - [ ] Include proper enum definitions for status fields
  - [ ] Add composite indexes for performance optimization
  - [ ] Validate schema for consistency and best practices

- [ ] Task 8: Generate and test database migrations (AC: 9)
  - [ ] Generate Prisma migration scripts for all new models
  - [ ] Test migrations in development environment
  - [ ] Verify foreign key constraints and data integrity
  - [ ] Test rollback procedures for all migrations
  - [ ] Document migration dependencies and order

- [ ] Task 9: Add performance indexes (AC: 10)
  - [ ] Add indexes for frequently queried fields (status, createdAt, etc.)
  - [ ] Create composite indexes for common query patterns
  - [ ] Add text search indexes for content fields
  - [ ] Verify index effectiveness with query analysis
  - [ ] Document index strategy and maintenance procedures

- [ ] Task 10: Create unit tests for models
  - [ ] Write Prisma model validation tests
  - [ ] Test foreign key constraints and cascade behavior
  - [ ] Test enum value validation and constraints
  - [ ] Verify audit field auto-population
  - [ ] Test migration scripts and rollback procedures

## Dev Notes

### Previous Story Insights
This is the first story in the Knowledge Management epic, establishing the foundational database schema for all subsequent features.

### Data Models from Architecture
**Core Knowledge Management Entities** [Source: docs/technical/specifications/knowledge-management.md]:
- Documents: File uploads with metadata, versioning, and approval workflows
- Communications: Email, chat, and message records with platform integration
- Facts: Extracted knowledge with confidence scoring and approval queues
- Tags: Hierarchical classification system for knowledge organization
- Categories: Knowledge categorization with parent-child relationships
- KnowledgeSource: External system integration configurations

**Database Technology Stack** [Source: docs/technical/tech-stack.md]:
- Database: PostgreSQL 16+
- ORM: Prisma for Node.js services
- Object Storage: MinIO for file storage
- Extensions: pgvector for semantic search capabilities

**Existing Data Schema Patterns** [Source: docs/technical/specifications/data-schema.md]:
- Standard audit fields: id (UUID), createdAt, updatedAt, createdBy
- Foreign key patterns using UUID references
- Enum definitions for status and type fields
- JSONB fields for flexible metadata storage
- Proper indexing strategy for performance

### API Specifications
**Knowledge Management Service Pattern** [Source: docs/technical/specifications/component-architecture.md]:
- New `knowledge` service in backend-node following existing patterns
- RESTful API endpoints for CRUD operations
- Integration with Keycloak for authentication
- Prisma ORM integration following established patterns

### File Locations
**Schema Location**: `backend-node/prisma/schema.prisma`
**Migration Location**: `backend-node/prisma/migrations/`
**Test Location**: `backend-node/src/__tests__/knowledge-management/`
**Service Location**: `backend-node/src/services/knowledge/`

### Testing Requirements
**Testing Standards** [Source: docs/technical/tech-stack.md]:
- Unit tests using Vitest + Testing Library
- Database testing with test database instances
- Migration testing with rollback verification
- Prisma model validation testing

### Technical Constraints
**Security Requirements**:
- Row-level security for multi-tenant data isolation
- Encryption at rest for sensitive content
- Audit logging for all data modifications
- Role-based access control integration

**Performance Requirements**:
- Optimized indexes for search and filtering operations
- Vector embedding support for semantic search
- Efficient querying for large document collections
- Proper foreign key constraint management

## Testing

### Testing Standards
**Test File Location**: `backend-node/src/__tests__/knowledge-management/km-models.test.js`

**Testing Framework**: Vitest with database test utilities

**Test Coverage Requirements**:
- Model validation and constraint testing
- Foreign key relationship verification
- Migration script validation
- Index performance verification
- Enum value validation

**Test Database Setup**:
- Use test PostgreSQL instance with pgvector extension
- Isolated test transactions for data consistency
- Migration testing with fresh database instances
- Rollback testing for all migration scripts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial story creation from KM implementation plan | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*